<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b0f1a" />
  <title>JSON Tools</title>
  <style>
    :root{
      --bg:#0b0f1a; --card:#111a2e; --text:#e8eefc; --muted:#a8b3d6;
      --border:#223055; --accent:#7aa7ff; --bad:#ff6b6b; --ok:#39d98a;
      --btn:#182447; --btn2:#1f2d57;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,sans-serif;
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --card:#ffffff; --text:#111827; --muted:#4b5563;
      --border:#e5e7eb; --accent:#2563eb; --bad:#dc2626; --ok:#16a34a;
      --btn:#f3f4f6; --btn2:#e5e7eb;
      --shadow: 0 10px 30px rgba(17,24,39,.10);
    }
    body{ margin:0; font-family:var(--sans); background:var(--bg); color:var(--text); }
    .wrap{ max-width:1100px; margin:0 auto; padding:20px 16px 40px; }
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .title{ display:flex; flex-direction:column; gap:4px; }
    h1{ margin:0; font-size:20px; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:13px; }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    button{
      border:1px solid var(--border);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    button:hover{ background:var(--btn2); }
    button.primary{ border-color:transparent; background:var(--accent); color:white; }
    button.primary:hover{ filter:brightness(.95); }
    button.danger{ border-color:transparent; background:var(--bad); color:white; }
    button.ghost{ background:transparent; }
    .tabs{
      margin-top:14px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tab{
      text-decoration:none;
      color:var(--text);
      border:1px solid var(--border);
      background:transparent;
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
      font-size:13px;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .tab:hover{ background: rgba(127,127,127,.08); }
    .tab.active{
      background: var(--btn2);
      border-color: transparent;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media(min-width:900px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 420px;
    }
    .card-head{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card-head .label{ font-weight:800; font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; }
    .stats{ font-size:12px; color:var(--muted); display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .dot{ width:8px; height:8px; border-radius:999px; display:inline-block; margin-right:6px; }
    .ok{ background:var(--ok); }
    .bad{ background:var(--bad); }

    textarea{
      flex:1;
      width:100%;
      resize:none;
      border:0;
      outline:none;
      padding:14px;
      background:transparent;
      color:var(--text);
      font-family:var(--mono);
      font-size:13px;
      line-height:1.45;
    }
    .bar{
      padding:12px 14px;
      border-top:1px solid var(--border);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .bar .left, .bar .right{ display:flex; gap:8px; flex-wrap:wrap; }
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(17,24,39,.92);
      color: white;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 30px rgba(0,0,0,.4);
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
      max-width: calc(100vw - 30px);
      text-align: center;
      z-index: 9999;
    }
    .toast.show{ opacity:1; }

    footer{ margin-top:14px; color:var(--muted); font-size:12px; }
    code.kbd{
      font-family:var(--mono);
      font-size: 12px;
      padding: 2px 6px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: rgba(127,127,127,.08);
    }
    .hidden{ display:none !important; }

    .onecol{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top:14px;
    }
    .note{
      padding:12px 14px;
      border:1px dashed var(--border);
      border-radius:14px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      background: rgba(127,127,127,.06);
    }
  </style>
</head>

<body>
  <div class="wrap" id="app">
    <header>
      <div class="title">
        <h1 id="h1">JSON Tools</h1>
        <div class="sub" id="subtitle">Beautify ‚Ä¢ Minify ‚Ä¢ Validate ‚Ä¢ Copy ‚Ä¢ Download ‚Ä¢ PWA</div>
      </div>
      <div class="controls">
        <button class="ghost" id="themeBtn" title="Theme">üåó <span id="themeTxt">Theme</span></button>
        <button class="ghost" id="langBtn" title="Language">üåç <span id="langTxt">RU</span></button>
        <button class="ghost" id="installBtn" style="display:none" title="Install">‚¨áÔ∏è <span id="installTxt">Install</span></button>
        <button class="ghost" id="clearAllBtn" title="Clear">üßπ <span id="clearTxt">Clear</span></button>
      </div>
    </header>

    <nav class="tabs" aria-label="Pages">
      <a class="tab" href="#tools" id="tabTools">üß∞ <span data-i="tab_tools">JSON Tools</span></a>
      <a class="tab" href="#tojson" id="tabToJson">üß™ <span data-i="tab_tojson">To JSON (best effort)</span></a>
    </nav>

    <!-- PAGE 1: JSON Tools -->
    <section id="pageTools">
      <div class="grid">
        <section class="card">
          <div class="card-head">
            <div class="label" data-i="label_input">Input JSON</div>
            <div class="stats" id="inStats">‚Äî</div>
          </div>
          <textarea id="input" spellcheck="false" placeholder=""></textarea>
          <div class="bar">
            <div class="left">
              <button class="primary" id="beautifyBtn">‚ú® <span data-i="btn_beautify">Beautify</span></button>
              <button id="minifyBtn">üßä <span data-i="btn_minify">Minify</span></button>
              <button id="validateBtn">‚úÖ <span data-i="btn_validate">Validate</span></button>
              <button id="sampleBtn">üß™ <span data-i="btn_sample">Sample</span></button>
            </div>
            <div class="right">
              <button id="copyInBtn">üìã <span data-i="btn_copy">Copy</span></button>
              <button id="downloadInBtn">üíæ <span data-i="btn_download">Download</span></button>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-head">
            <div class="label" data-i="label_output">Output</div>
            <div class="stats" id="outStats"><span class="dot ok"></span><span data-i="status_ready">Ready</span></div>
          </div>
          <textarea id="output" spellcheck="false" placeholder="" readonly></textarea>
          <div class="bar">
            <div class="left">
              <button id="swapBtn" title="Swap">‚Ü©Ô∏è <span data-i="btn_out_to_in">Output ‚Üí Input</span></button>
              <button class="danger" id="clearOutBtn" title="Clear output">üóëÔ∏è <span data-i="btn_clear_output">Clear Output</span></button>
            </div>
            <div class="right">
              <button id="copyOutBtn">üìã <span data-i="btn_copy">Copy</span></button>
              <button id="downloadOutBtn">üíæ <span data-i="btn_download">Download</span></button>
            </div>
          </div>
        </section>
      </div>

      <footer id="footerTools">
        <span data-i="hint_1">Tip: on Android you can use browser menu ‚Üí ‚ÄúAdd to Home screen‚Äù.</span>
        <span> </span>
        <span data-i="hint_2">Fast flow:</span>
        <code class="kbd">Beautify</code> ‚Üí <code class="kbd">Copy</code>.
      </footer>
    </section>

    <!-- PAGE 2: To JSON (best effort) -->
    <section id="pageToJson" class="hidden">
      <div class="onecol">
        <div class="note">
          <b data-i="tojson_note_title">What is this?</b><br/>
          <span data-i="tojson_note_body">
            Paste almost any ‚Äúcode-ish‚Äù text (JS-like objects, single quotes, unquoted keys, trailing commas).
            The tool will try to extract a JSON-ish fragment and convert it to valid JSON for readability.
            If it fails, you‚Äôll still see the attempted JSON and the parser error.
          </span>
        </div>

        <section class="card" style="min-height: 520px;">
          <div class="card-head">
            <div class="label" data-i="label_any_input">Any input</div>
            <div class="stats" id="anyStats">‚Äî</div>
          </div>
          <textarea id="anyInput" spellcheck="false" placeholder=""></textarea>
          <div class="bar">
            <div class="left">
              <button class="primary" id="convertBtn">ü™Ñ <span data-i="btn_convert">Convert to JSON</span></button>
              <button id="extractBtn">üß≤ <span data-i="btn_extract">Extract JSON-ish</span></button>
              <button id="anySampleBtn">üß™ <span data-i="btn_sample">Sample</span></button>
            </div>
            <div class="right">
              <button id="copyAnyBtn">üìã <span data-i="btn_copy">Copy</span></button>
              <button id="downloadAnyBtn">üíæ <span data-i="btn_download">Download</span></button>
            </div>
          </div>
        </section>

        <section class="card" style="min-height: 520px;">
          <div class="card-head">
            <div class="label" data-i="label_attempted">Attempted JSON / Result</div>
            <div class="stats" id="anyOutStats"><span class="dot ok"></span><span data-i="status_ready">Ready</span></div>
          </div>
          <textarea id="anyOutput" spellcheck="false" placeholder="" readonly></textarea>
          <div class="bar">
            <div class="left">
              <button id="useAsJsonToolsBtn">‚Ü©Ô∏è <span data-i="btn_send_to_tools">Send to JSON Tools</span></button>
              <button class="danger" id="clearAnyOutBtn">üóëÔ∏è <span data-i="btn_clear_output">Clear Output</span></button>
            </div>
            <div class="right">
              <button id="copyAnyOutBtn">üìã <span data-i="btn_copy">Copy</span></button>
              <button id="downloadAnyOutBtn">üíæ <span data-i="btn_download">Download</span></button>
            </div>
          </div>
        </section>

        <footer id="footerToJson">
          <span data-i="tojson_footer">
            Pro tip: if conversion succeeded, hit ‚ÄúSend to JSON Tools‚Äù ‚Üí then Beautify/Minify/Validate as usual.
          </span>
        </footer>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---------- tiny i18n ----------
    const I18N = {
      ru: {
        title: "JSON Tools",
        subtitle: "Beautify ‚Ä¢ Minify ‚Ä¢ Validate ‚Ä¢ Copy ‚Ä¢ Download ‚Ä¢ PWA",
        theme: "–¢–µ–º–∞",
        install: "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",
        clear: "–û—á–∏—Å—Ç–∏—Ç—å",
        tab_tools: "JSON Tools",
        tab_tojson: "–í JSON (best effort)",
        label_input: "–í–≤–æ–¥ JSON",
        label_output: "–†–µ–∑—É–ª—å—Ç–∞—Ç",
        label_any_input: "–õ—é–±–æ–π –≤–≤–æ–¥",
        label_attempted: "–ü–æ–ø—ã—Ç–∫–∞ JSON / –†–µ–∑—É–ª—å—Ç–∞—Ç",
        btn_beautify: "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å",
        btn_minify: "–°–∂–∞—Ç—å",
        btn_validate: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å",
        btn_sample: "–ü—Ä–∏–º–µ—Ä",
        btn_copy: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
        btn_download: "–°–∫–∞—á–∞—Ç—å",
        btn_out_to_in: "–†–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí –í–≤–æ–¥",
        btn_clear_output: "–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        status_ready: "–ì–æ—Ç–æ–≤–æ",
        status_beautified: "–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–æ",
        status_minified: "–°–∂–∞—Ç–æ",
        status_valid: "JSON –≤–∞–ª–∏–¥–µ–Ω",
        status_invalid: "–û—à–∏–±–∫–∞ JSON",
        placeholder_input: "–í—Å—Ç–∞–≤—å JSON —Å—é–¥–∞‚Ä¶",
        placeholder_output: "–¢—É—Ç –ø–æ—è–≤–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç‚Ä¶",
        hint_1: "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞ Android –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞ ‚Üí ‚Äú–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω‚Äù.",
        hint_2: "–ë—ã—Å—Ç—Ä—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:",
        tojson_note_title: "–ß—Ç–æ —ç—Ç–æ?",
        tojson_note_body: "–í—Å—Ç–∞–≤—å –ø–æ—á—Ç–∏ –ª—é–±–æ–π ‚Äú–∫–æ–¥–æ–ø–æ–¥–æ–±–Ω—ã–π‚Äù —Ç–µ–∫—Å—Ç (JS-–ø–æ–¥–æ–±–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã, –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏, –∫–ª—é—á–∏ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫, –ª–∏—à–Ω–∏–µ –∑–∞–ø—è—Ç—ã–µ). –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–ø—Ä–æ–±—É–µ—Ç –≤—ã—Ç–∞—â–∏—Ç—å JSON-–ø–æ—Ö–æ–∂–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –≤ –≤–∞–ª–∏–¥–Ω—ã–π JSON –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏. –ï—Å–ª–∏ –Ω–µ –≤—ã—à–ª–æ ‚Äî —Ç—ã –≤—Å—ë —Ä–∞–≤–Ω–æ —É–≤–∏–¥–∏—à—å –ø–æ–ø—ã—Ç–∫—É –∏ –æ—à–∏–±–∫—É –ø–∞—Ä—Å–µ—Ä–∞.",
        btn_convert: "–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ JSON",
        btn_extract: "–í—ã—Ç–∞—â–∏—Ç—å JSON-–ø–æ—Ö–æ–∂–µ–µ",
        btn_send_to_tools: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ JSON Tools",
        tojson_footer: "–°–æ–≤–µ—Ç: –µ—Å–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —É–¥–∞–ª–∞—Å—å, –Ω–∞–∂–º–∏ ‚Äú–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ JSON Tools‚Äù –∏ –¥–∞–ª—å—à–µ –ø–æ–ª—å–∑—É–π—Å—è Beautify/Minify/Validate."
      },
      en: {
        title: "JSON Tools",
        subtitle: "Beautify ‚Ä¢ Minify ‚Ä¢ Validate ‚Ä¢ Copy ‚Ä¢ Download ‚Ä¢ PWA",
        theme: "Theme",
        install: "Install",
        clear: "Clear",
        tab_tools: "JSON Tools",
        tab_tojson: "To JSON (best effort)",
        label_input: "Input JSON",
        label_output: "Output",
        label_any_input: "Any input",
        label_attempted: "Attempted JSON / Result",
        btn_beautify: "Beautify",
        btn_minify: "Minify",
        btn_validate: "Validate",
        btn_sample: "Sample",
        btn_copy: "Copy",
        btn_download: "Download",
        btn_out_to_in: "Output ‚Üí Input",
        btn_clear_output: "Clear Output",
        status_ready: "Ready",
        status_beautified: "Beautified",
        status_minified: "Minified",
        status_valid: "Valid JSON",
        status_invalid: "Invalid JSON",
        placeholder_input: "Paste JSON here‚Ä¶",
        placeholder_output: "Result will appear here‚Ä¶",
        hint_1: "Tip: on Android you can use browser menu ‚Üí ‚ÄúAdd to Home screen‚Äù.",
        hint_2: "Fast flow:",
        tojson_note_title: "What is this?",
        tojson_note_body: "Paste almost any ‚Äúcode-ish‚Äù text (JS-like objects, single quotes, unquoted keys, trailing commas). The tool will try to extract a JSON-ish fragment and convert it to valid JSON for readability. If it fails, you‚Äôll still see the attempted JSON and the parser error.",
        btn_convert: "Convert to JSON",
        btn_extract: "Extract JSON-ish",
        btn_send_to_tools: "Send to JSON Tools",
        tojson_footer: "Pro tip: if conversion succeeded, hit ‚ÄúSend to JSON Tools‚Äù ‚Üí then Beautify/Minify/Validate as usual."
      }
    };

    const $ = (id) => document.getElementById(id);
    const toastEl = $("toast");
const OK = "OK";

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 1500);
    }

    function setLang(lang){
      localStorage.setItem("json_tools_lang", lang);
      const t = I18N[lang] || I18N.en;

      $("h1").textContent = t.title;
      $("subtitle").textContent = t.subtitle;

      $("themeTxt").textContent = t.theme;
      $("installTxt").textContent = t.install;
      $("clearTxt").textContent = t.clear;

      $("langTxt").textContent = (lang === "ru" ? "RU" : "EN");

      document.querySelectorAll("[data-i]").forEach(el=>{
        const key = el.getAttribute("data-i");
        if(t[key]) el.textContent = t[key];
      });

      $("input").placeholder = t.placeholder_input;
      $("output").placeholder = t.placeholder_output;
      $("anyInput").placeholder = (lang === "ru")
        ? "–í—Å—Ç–∞–≤—å —Å—é–¥–∞ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç/–∫–æ–¥‚Ä¶ –Ω–∞–ø—Ä–∏–º–µ—Ä: const data = {a:1, b:'x',};"
        : "Paste any text/code here‚Ä¶ e.g. const data = {a:1, b:'x',};";
      $("anyOutput").placeholder = (lang === "ru")
        ? "–¢—É—Ç –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–ø—ã—Ç–∫–∞ JSON –∏/–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç‚Ä¶"
        : "Attempted JSON and/or result will appear here‚Ä¶";

      document.title = t.title;

      // refresh statuses
      if($("outStats").dataset.state === "ready") setOutStatus(true, t.status_ready);
      if($("anyOutStats").dataset.state === "ready") setAnyOutStatus(true, t.status_ready);
    }

    // ---------- theme ----------
    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("json_tools_theme", theme);
    }
    function toggleTheme(){
      const cur = localStorage.getItem("json_tools_theme") || "dark";
      applyTheme(cur === "dark" ? "light" : "dark");
      toast("OK");
    }

    // ---------- JSON tools page ----------
    function safeParseJSON(text){
      const cleaned = (text || "").replace(/^\uFEFF/, "").trim();
      if(!cleaned) throw new Error("Empty input");
      return JSON.parse(cleaned);
    }

    function formatBytes(n){
      if(!Number.isFinite(n)) return "‚Äî";
      const units = ["B","KB","MB","GB"];
      let i=0, v=n;
      while(v>=1024 && i<units.length-1){ v/=1024; i++; }
      return (i===0? v.toFixed(0) : v.toFixed(1)) + " " + units[i];
    }
    function countLines(text){ return (text.match(/\n/g) || []).length + 1; }

    function updateStats(){
      const t = $("input").value || "";
      const bytes = new Blob([t]).size;
      $("inStats").textContent = t.trim()
        ? `${formatBytes(bytes)} ‚Ä¢ ${countLines(t)} lines`
        : "‚Äî";
    }

    function setOutStatus(ok, msg){
      $("outStats").dataset.state = ok ? "ok" : "bad";
      $("outStats").innerHTML = OK
        ? `<span class="dot ok"></span>${msg}`
        : `<span class="dot bad"></span>${msg}`;
    }
    function setReadyStatus(){
      const lang = localStorage.getItem("json_tools_lang") || "ru";
      const t = I18N[lang] || I18N.en;
      $("outStats").dataset.state = "ready";
      setOutStatus(true, t.status_ready);
    }
  function beautify(){
  const src = $("input").value;
  const lang = localStorage.getItem("json_tools_lang") || "ru";
  const t = I18N[lang] || I18N.en;
  try{
    const obj = safeParseJSON(src);
    const out = JSON.stringify(obj, null, 2);
    $("output").value = out;
    setOutStatus(true, t.status_beautified);
    toast("‚úÖ");
  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);
    $("output").value =
      (lang === "ru" ? "–û—à–∏–±–∫–∞ JSON:\n" : "JSON error:\n") + msg +
      "\n\n" + (lang === "ru" ? "–í–≤–æ–¥:\n" : "Input:\n") + (src || "");
    setOutStatus(false, t.status_invalid);
    toast("‚ùå");
  }
}

function minify(){
  const src = $("input").value;
  const lang = localStorage.getItem("json_tools_lang") || "ru";
  const t = I18N[lang] || I18N.en;
  try{
    const obj = safeParseJSON(src);
    const out = JSON.stringify(obj);
    $("output").value = out;
    setOutStatus(true, t.status_minified);
    toast("‚úÖ");
  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);
    $("output").value =
      (lang === "ru" ? "–û—à–∏–±–∫–∞ JSON:\n" : "JSON error:\n") + msg + 
      "\n\n" + (lang === "ru" ? "–í–≤–æ–¥:\n" : "Input:\n") + (src || "");
    setOutStatus(false, t.status_invalid);
    toast("‚ùå");
  }
}

function validate(){
  const src = $("input").value;
  const lang = localStorage.getItem("json_tools_lang") || "ru";
  const t = I18N[lang] || I18N.en;
  try{
    safeParseJSON(src);
    $("output").value = (lang === "ru")
      ? "‚úÖ JSON –≤–∞–ª–∏–¥–µ–Ω"
      : "‚úÖ JSON is valid";
    setOutStatus(true, t.status_valid);
    toast("‚úÖ");
  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);
    $("output").value =
      (lang === "ru" ? "‚ùå –û—à–∏–±–∫–∞ JSON:\n" : "‚ùå JSON error:\n") + msg;
    setOutStatus(false, t.status_invalid);
    toast("‚ùå");
  }
}

    function sample(){
      const s = {
        user: { id: 123, name: "Evgeny", tags: ["android","pwa","json"] },
        settings: { theme: "dark", ads: false },
        items: [
          { sku: "A1", qty: 2, price: 9.99 },
          { sku: "B7", qty: 1, price: 29.5 }
        ],
        meta: { created_at: new Date().toISOString() }
      };
      $("input").value = JSON.stringify(s, null, 2);
      updateStats();
      toast("OK");
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        toast("üìã");
      }catch{
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        toast("üìã");
      }
    }

    function downloadText(filename, text, mime="application/json;charset=utf-8"){
      const blob = new Blob([text], {type:mime});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 600);
    }

    // ---------- Page 2: best-effort to JSON ----------
    function updateAnyStats(){
      const t = $("anyInput").value || "";
      const bytes = new Blob([t]).size;
      $("anyStats").textContent = t.trim()
        ? `${formatBytes(bytes)} ‚Ä¢ ${countLines(t)} lines`
        : "‚Äî";
    }

    function setAnyOutStatus(ok, msg){
      $("anyOutStats").dataset.state = ok ? "ok" : "bad";
      $("anyOutStats").innerHTML = ok
        ? `<span class="dot ok"></span>${msg}`
        : `<span class="dot bad"></span>${msg}`;
    }
    function setAnyReady(){
      const lang = localStorage.getItem("json_tools_lang") || "ru";
      const t = I18N[lang] || I18N.en;
      $("anyOutStats").dataset.state = "ready";
      setAnyOutStatus(true, t.status_ready);
    }

    function extractJsonish(text){
      // Strategy:
      // - find first '{' or '['
      // - then scan forward for matching closing brace/bracket
      const s = (text || "");
      const startCurly = s.indexOf("{");
      const startBrack = s.indexOf("[");
      let start = -1;
      if(startCurly === -1) start = startBrack;
      else if(startBrack === -1) start = startCurly;
      else start = Math.min(startCurly, startBrack);
      if(start < 0) return "";

      const open = s[start];
      const close = open === "{" ? "}" : "]";
      let depth = 0;
      let inStr = false;
      let strQ = "";
      let esc = false;

      for(let i=start; i<s.length; i++){
        const ch = s[i];

        if(inStr){
          if(esc){ esc = false; continue; }
          if(ch === "\\"){ esc = true; continue; }
          if(ch === strQ){ inStr = false; strQ = ""; }
          continue;
        } else {
          if(ch === '"' || ch === "'"){ inStr = true; strQ = ch; continue; }
          if(ch === open) depth++;
          if(ch === close){
            depth--;
            if(depth === 0){
              return s.slice(start, i+1);
            }
          }
        }
      }
      // fallback: return from start to end
      return s.slice(start);
    }

    function softJsonify(input){
      // Best-effort "JS-ish -> JSON" conversion (heuristics):
      // 1) extract JSON-ish fragment
      // 2) remove comments
      // 3) convert single-quoted strings to double-quoted (simple, not perfect)
      // 4) quote unquoted keys
      // 5) remove trailing commas
      // 6) normalize weird tokens: undefined/NaN/Infinity -> null
      // 7) try parse JSON
      const extracted = extractJsonish(input) || input || "";
      let s = extracted.trim();

      // Remove JS comments (basic)
      s = s.replace(/\/\*[\s\S]*?\*\//g, "");
      s = s.replace(/(^|[^:])\/\/.*$/gm, "$1");

            // Replace backticks with quotes (rough)
      s = s.replace(/`([^`\\]*(\\.[^`\\]*)*)`/g, (_, body) => `"${body.replace(/"/g, '\\"')}"`);

      // Convert single quotes to double quotes for strings (rough, avoids \')
      s = s.replace(/'([^'\\]*(\\.[^'\\]*)*)'/g, (_, body) => `"${body.replace(/"/g, '\\"')}"`);

      // Quote unquoted object keys: { foo: 1, bar_baz: 2 }
      // Also supports keys after comma: , foo:
      s = s.replace(/([{,]\s*)([A-Za-z_$][\w$-]*)(\s*:)/g, '$1"$2"$3');

      // Replace = with : in obvious object-like contexts (rare)
      s = s.replace(/([{,]\s*"(?:[^"\\]|\\.)+"\s*)=/g, "$1:");

      // Remove trailing commas: { "a": 1, } or [1,2,]
      s = s.replace(/,\s*([}\]])/g, "$1");

      // Replace undefined/NaN/Infinity with null
      s = s.replace(/\bundefined\b/g, "null");
      s = s.replace(/\bNaN\b/g, "null");
      s = s.replace(/\bInfinity\b/g, "null");
      s = s.replace(/\b-Infinity\b/g, "null");

      return { extracted, attempted: s };
    }

    function convertToJson(){
      const lang = localStorage.getItem("json_tools_lang") || "ru";
      const t = I18N[lang] || I18N.en;

      const raw = $("anyInput").value || "";
      if(!raw.trim()){
        $("anyOutput").value = "";
        setAnyOutStatus(false, lang === "ru" ? "–ü—É—Å—Ç–æ–π –≤–≤–æ–¥" : "Empty input");
        toast("ü§∑");
        return;
      }

      const { extracted, attempted } = softJsonify(raw);

      // Try parse
      try{
        const obj = JSON.parse(attempted);
        const pretty = JSON.stringify(obj, null, 2);
        $("anyOutput").value = pretty;
        setAnyOutStatus(true, lang === "ru" ? "–£—Å–ø–µ—à–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ" : "Converted");
        toast("‚úÖ");
      }catch(e){
        // Show attempted + error for visibility
        $("anyOutput").value =
          (lang === "ru"
            ? "=== –ü–æ–ø—ã—Ç–∫–∞ JSON ===\n"
            : "=== Attempted JSON ===\n")
          + attempted
          + "\n\n"
          + (lang === "ru"
            ? "=== –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ ===\n"
            : "=== Parse error ===\n")
          + (e && e.message ? e.message : String(e))
          + "\n\n"
          + (lang === "ru"
            ? "=== –ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç (–¥–æ –ø—Ä–∞–≤–æ–∫) ===\n"
            : "=== Extracted fragment (before fixes) ===\n")
          + extracted;

        setAnyOutStatus(false, lang === "ru" ? "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å" : "Failed to parse");
        toast("‚ùå");
      }
    }

    function extractOnly(){
      const lang = localStorage.getItem("json_tools_lang") || "ru";
      const raw = $("anyInput").value || "";
      const frag = extractJsonish(raw);
      if(!frag){
        $("anyOutput").value = "";
        setAnyOutStatus(false, lang === "ru" ? "–ù–µ—á–µ–≥–æ –∏–∑–≤–ª–µ—á—å" : "Nothing to extract");
        toast("ü§∑");
        return;
      }
      $("anyOutput").value = frag;
      setAnyOutStatus(true, lang === "ru" ? "–§—Ä–∞–≥–º–µ–Ω—Ç –∏–∑–≤–ª–µ—á—ë–Ω" : "Extracted");
      toast("üß≤");
    }

    function anySample(){
      const lang = localStorage.getItem("json_tools_lang") || "ru";
      $("anyInput").value =
        (lang === "ru")
        ? `// JS-–ø–æ–¥–æ–±–Ω—ã–π –æ–±—ä–µ–∫—Ç + –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ + –ª–∏—à–Ω—è—è –∑–∞–ø—è—Ç–∞—è
const payload = {
  user: {id: 42, name: 'Evgeny',},
  enabled: true,
  tags: ['android','pwa',],
  meta: {createdAt: "2026-01-20T12:34:56Z"},
};
// –∞ –≤–æ—Ç –µ—â—ë –∫—É—Å–æ–∫:
[{a:1, b:'x',}, {c:2}]`
        : `// JS-ish object + single quotes + trailing commas
const payload = {
  user: {id: 42, name: 'Evgeny',},
  enabled: true,
  tags: ['android','pwa',],
  meta: {createdAt: "2026-01-20T12:34:56Z"},
};
// another fragment:
[{a:1, b:'x',}, {c:2}]`;
      updateAnyStats();
      toast("OK");
    }

    // ---------- PWA minimal (manifest + SW via blob) ----------
    function svgIcon(size){
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 100 100">
          <rect x="8" y="8" width="84" height="84" rx="18" fill="#7aa7ff"/>
          <text x="50" y="58" text-anchor="middle" font-size="44" font-family="Arial" fill="#fff">{ }</text>
        </svg>
      `.trim();
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    }

    function setupPWA(){
      const manifest = {
        name: "JSON Tools",
        short_name: "JSON Tools",
        start_url: ".",
        display: "standalone",
        background_color: "#0b0f1a",
        theme_color: "#0b0f1a",
        icons: [
          { src: svgIcon(192), sizes: "192x192", type: "image/svg+xml" },
          { src: svgIcon(512), sizes: "512x512", type: "image/svg+xml" }
        ]
      };
      const manifestBlob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const manifestUrl = URL.createObjectURL(manifestBlob);
      const link = document.createElement("link");
      link.rel = "manifest";
      link.href = manifestUrl;
      document.head.appendChild(link);

      if("serviceWorker" in navigator){
        const swCode = `
          const CACHE = "json-tools-v2";
          self.addEventListener("install", (e) => {
            e.waitUntil(caches.open(CACHE).then(c => c.addAll(["./"])));
            self.skipWaiting();
          });
          self.addEventListener("activate", (e) => e.waitUntil(self.clients.claim()));
          self.addEventListener("fetch", (e) => {
            e.respondWith(
              caches.match(e.request).then(r => r || fetch(e.request).then(res => {
                const copy = res.clone();
                if(e.request.method === "GET" && new URL(e.request.url).origin === location.origin){
                  caches.open(CACHE).then(c => c.put(e.request, copy));
                }
                return res;
              }).catch(()=>caches.match("./")))
            );
          });
        `;
        const swBlob = new Blob([swCode], {type:"text/javascript"});
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl).catch(()=>{});
      }
    }

    // ---------- install prompt ----------
    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      $("installBtn").style.display = "inline-flex";
    });

    // ---------- routing (2 pages) ----------
    function setPage(hash){
      const h = (hash || location.hash || "#tools").toLowerCase();
      const tools = (h === "#tools" || h === "" || h === "#");
      $("pageTools").classList.toggle("hidden", !tools);
      $("pageToJson").classList.toggle("hidden", tools);

      $("tabTools").classList.toggle("active", tools);
      $("tabToJson").classList.toggle("active", !tools);
    }

    // ---------- wire up ----------
    (function init(){
      // defaults
      applyTheme(localStorage.getItem("json_tools_theme") || "dark");
      setLang(localStorage.getItem("json_tools_lang") || "ru");
      setupPWA();

      // routing
      setPage(location.hash);
      window.addEventListener("hashchange", () => setPage(location.hash));

      // JSON tools
      $("input").addEventListener("input", updateStats);
      $("beautifyBtn").addEventListener("click", beautify);
      $("minifyBtn").addEventListener("click", minify);
      $("validateBtn").addEventListener("click", validate);
      $("sampleBtn").addEventListener("click", sample);

      $("copyInBtn").addEventListener("click", ()=>copyText($("input").value || ""));
      $("copyOutBtn").addEventListener("click", ()=>copyText($("output").value || ""));

      $("downloadInBtn").addEventListener("click", ()=>{
        const t = $("input").value || "";
        if(!t.trim()) return toast("ü§∑");
        downloadText("input.json", t);
        toast("üíæ");
      });
      $("downloadOutBtn").addEventListener("click", ()=>{
        const t = $("output").value || "";
        if(!t.trim()) return toast("ü§∑");
        downloadText("output.json", t);
        toast("üíæ");
      });

      $("swapBtn").addEventListener("click", ()=>{
        const t = $("output").value || "";
        if(!t.trim()) return toast("ü§∑");
        $("input").value = t;
        updateStats();
        toast("‚Ü©Ô∏è");
      });

      $("clearOutBtn").addEventListener("click", ()=>{
        $("output").value = "";
        setReadyStatus();
        toast("OK");
      });

    $("clearAllBtn").addEventListener("click", ()=>{
  // JSON Tools
  $("input").value = "";
  $("output").value = "";
  updateStats();
  setReadyStatus();

  // To JSON
  $("anyInput").value = "";
  $("anyOutput").value = "";
  updateAnyStats();
  setAnyReady();

  toast("OK");
});

      // page 2
      $("anyInput").addEventListener("input", updateAnyStats);
      $("convertBtn").addEventListener("click", convertToJson);
      $("extractBtn").addEventListener("click", extractOnly);
      $("anySampleBtn").addEventListener("click", anySample);

      $("copyAnyBtn").addEventListener("click", ()=>copyText($("anyInput").value || ""));
      $("downloadAnyBtn").addEventListener("click", ()=>{
        const t = $("anyInput").value || "";
        if(!t.trim()) return toast("ü§∑");
        downloadText("input.txt", t, "text/plain;charset=utf-8");
        toast("üíæ");
      });

      $("copyAnyOutBtn").addEventListener("click", ()=>copyText($("anyOutput").value || ""));
      $("downloadAnyOutBtn").addEventListener("click", ()=>{
        const t = $("anyOutput").value || "";
        if(!t.trim()) return toast("ü§∑");
        downloadText("result.json", t, "application/json;charset=utf-8");
        toast("üíæ");
      });

      $("useAsJsonToolsBtn").addEventListener("click", ()=>{
        const t = $("anyOutput").value || "";
        if(!t.trim()) return toast("ü§∑");
        $("input").value = t;
        updateStats();
        location.hash = "#tools";
        toast("‚Ü©Ô∏è");
      });

      $("clearAnyOutBtn").addEventListener("click", ()=>{
        $("anyOutput").value = "";
        setAnyReady();
        toast("OK");
      });

      // top controls
      $("themeBtn").addEventListener("click", toggleTheme);
      $("langBtn").addEventListener("click", ()=>{
        const cur = localStorage.getItem("json_tools_lang") || "ru";
        setLang(cur === "ru" ? "en" : "ru");
        toast("OK");
      });

      $("installBtn").addEventListener("click", async () => {
        if(!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice.catch(()=>{});
        deferredPrompt = null;
        $("installBtn").style.display = "none";
        toast("OK");
      });

      // initial status
      updateStats();
      updateAnyStats();
      setReadyStatus();
      setAnyReady();
    })();
  </script>
</body>
</html>